<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Stomp the Mole</title>
   <style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
}

body {
  min-height: 100vh;
  background: linear-gradient(135deg, #0f0f23 0%, #1a1a2e 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
}

/* BUTTONS */
.btn-primary, .btn-primary-b {
  padding: clamp(8px, 2.5vw, 12px) clamp(14px, 4vw, 20px);
  border: none;
  border-radius: 8px;
  cursor: pointer;
  font-weight: 600;
  font-size: clamp(14px, 4vw, 16px);
  background: linear-gradient(90deg, #85c8ff, #d6fa61);
  color: black;
  transition: transform 0.2s ease, opacity 0.2s ease;
}
.btn-primary:hover, .btn-primary-b:hover {
  opacity: 0.85;
  transform: scale(1.03);
}
.btn-secondary {
  background: #85c8ff;
  color: black;
}

/* GAME CONTAINER */
.game-container {
  position: relative;
  width: 90vw;
  height: 70vh;
  max-width: 1000px;
  max-height: 750px;
  margin: auto;
  border: 1px solid rgba(214, 250, 97, 0.5);
  border-radius: 20px;
  overflow: hidden;
  background: #1b2337;
  box-shadow: 0 0 15px #3f452b,
              0 0 15px #d6fa61,
              0 0 15px rgba(214, 250, 97, 0.8);
}
#videoElement,
#gameCanvas {
  width: 100%;
  height: 100%;
  object-fit: cover;
}
#gameCanvas {
  position: absolute;
  top: 0;
  left: 0;
  pointer-events: none;
}

/* HUD */
#hud {
  position: absolute;
  top: 16px;
  left: 16px;
  z-index: 10;
  background: rgba(0, 0, 0, 0.6);
  padding: clamp(6px, 1.5vw, 12px) clamp(8px, 2vw, 16px);
  border-radius: 12px;
  border: 2px solid #85c8ff;
  font-weight: 600;
  box-shadow: 0 0 15px #2f2a63, 0 0 15px #0f1248, 0 0 15px #61b3fa;
  font-size: clamp(12px, 2vw, 16px);
}
#hud .val {
  font-weight: 800;
  font-size: clamp(14px, 2.5vw, 18px);
}

/* HAND CURSOR */
.handCursor {
  position: absolute;
  width: 44px;
  height: 44px;
  background: rgba(169, 250, 48, 0.4);
  border-radius: 50%;
  border: 3px solid rgba(150, 255, 102, 0.8);
  box-shadow: 0 0 20px rgba(16, 185, 129, 0.4),
              inset 0 0 20px rgba(16, 185, 129, 0.2);
  pointer-events: none;
  z-index: 30;
  transition: transform 100ms, opacity 150ms;
  opacity: 0;
  transform: translate(-50%, -50%);
}

/* GAME OVER SCREEN */
#gameOverScreen {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(15, 15, 35, 0.9);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 50;
}
#gameOverCard {
  background: #1f2937;
  border: 2px solid #85c8ff;
  border-radius: 16px;
  padding: clamp(16px, 4vw, 28px);
  text-align: center;
  width: min(92vw, 440px);
  box-shadow: 0 0 25px rgba(133, 200, 255, 0.5);
}
#gameOverCard h2 {
  font-size: clamp(20px, 5vw, 28px);
  margin-bottom: 1rem;
}
#gameOverCard .new-high {
  font-size: clamp(16px, 3.5vw, 20px);
  color: #d6fa61;
  margin-bottom: 1rem;
}
#finalStats {
  font-size: clamp(13px, 3vw, 15px);
  line-height: 1.6;
  margin-bottom: 1.5rem;
}

/* SMALL SCREENS */
@media (max-width: 500px) {
  .game-container {
    height: 65vh !important;
  }
  #hud {
    top: 8px;
    left: 8px;
  }
  #gameOverCard {
    width: 95vw;
  }
}
</style>

  </head>
  <body>
    <div class="game-container">
      <video id="videoElement" autoplay muted playsinline></video>
      <canvas id="gameCanvas"></canvas>
      <div id="hud">
        Score: <span id="score" class="val">0</span> | Time:
        <span id="time" class="val">0</span>s
      </div>
<div id="gameOver">
  <div id="gameOverCard">
    <h2>Game Over</h2>
    <div class="new-high">Great work!</div>
    <div id="finalStats">
      <p>Score: 12</p>
      <p>Level: 3</p>
      <p>Time: 35s</p>
    </div>
    <button
      class="btn-primary"
      onclick="location.reload()"
    >
      Play again
    </button>
    <br><br>
    <button
      class="btn-primary-b"
      onclick="window.location.href = 'level1.html'"
    >
     ‚Üê Back
    </button>
  </div>
</div>
    </div>

  <!-- MediaPipe -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

  <script>
    const video=document.getElementById('videoElement');
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d');
    const container=document.querySelector('.game-container');
    const scoreEl=document.getElementById('score');
    const timeEl=document.getElementById('time');

    let score=0,timeSec=0,gameRunning=false;
    let moles=[],spawnTimer=null,secondTimer=null;
    const MOLE_SIZE=90,MOLE_LIFETIME_MS=4500,SPAWN_INTERVAL_MS=1200; // faster spawn
    let lastFootX=null;
    let feet=[]; // current feet positions
    let prevFeet=[]; // previous frame feet positions
    const STOMP_THRESHOLD=10; // px/frame downward speed needed for stomp
    let highScore=0;

    function resizeCanvas(){canvas.width=container.clientWidth;canvas.height=container.clientHeight;}
    window.addEventListener('resize',resizeCanvas);

    // Pose setup
    function initPose(){
      const pose=new Pose({locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}`});
      pose.setOptions({modelComplexity:1,smoothLandmarks:true,selfieMode:true,minDetectionConfidence:0.5,minTrackingConfidence:0.5});
      pose.onResults(onResults);
      const cam=new Camera(video,{onFrame:async()=>{if(video.videoWidth>0)await pose.send({image:video});},width:1280,height:720});
      cam.start();
    }

    function onResults(results){
      if(!gameRunning) return;
      if(!(results.poseLandmarks&&results.poseLandmarks.length>=33)) return;

      const w=canvas.width,h=canvas.height;
      const L_FOOT=results.poseLandmarks[31]||results.poseLandmarks[27];
      const R_FOOT=results.poseLandmarks[32]||results.poseLandmarks[28];
      if(!L_FOOT||!R_FOOT) return;

      prevFeet=feet.map(f=>({...f})); // save last frame
      feet=[
        {x:L_FOOT.x*w,y:L_FOOT.y*h},
        {x:R_FOOT.x*w,y:R_FOOT.y*h}
      ];

      lastFootX=(feet[0].x+feet[1].x)/2;

      // check stomp hits
      feet.forEach((f,i)=>{
        if(prevFeet[i]) {
          let vy=f.y-prevFeet[i].y; // downward speed
          if(vy>STOMP_THRESHOLD) checkHit(f.x,f.y); 
        }
      });
    }

    function checkHit(x,y){
      for(const m of moles){
        if(!m.alive) continue;
        const dx=x-m.x,dy=y-m.y,dist=Math.hypot(dx,dy);
        if(dist<MOLE_SIZE*0.7){
          m.alive=false;
          score+=10;
          scoreEl.textContent=score;
        }
      }
    }

    function spawnMole(){
      if(!gameRunning) return;
      const w=canvas.width,h=canvas.height;
      let x;
      if(lastFootX!=null){
        const spread=Math.max(120,w*0.2);
        x=Math.min(Math.max(lastFootX+(Math.random()*2-1)*spread,MOLE_SIZE/2+10),w-MOLE_SIZE/2-10);
      }else{
        x=Math.random()*(w-MOLE_SIZE-20)+(MOLE_SIZE/2+10);
      }
      const y=h-70;
      const m={x,y,size:MOLE_SIZE,born:performance.now(),alive:true};
      moles.push(m);
      setTimeout(()=>{m.alive=false;},MOLE_LIFETIME_MS);
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);
      for(const m of moles){
        if(!m.alive) continue;
        ctx.beginPath();
        ctx.arc(m.x,m.y,m.size/2,0,Math.PI*2);
        ctx.fillStyle='#8b5e3c';ctx.fill();
        ctx.fillStyle='#000';
        ctx.beginPath();ctx.arc(m.x-m.size*0.15,m.y-8,5,0,Math.PI*2);ctx.fill();
        ctx.beginPath();ctx.arc(m.x+m.size*0.15,m.y-8,5,0,Math.PI*2);ctx.fill();
        ctx.fillStyle='#fbbf24';ctx.beginPath();ctx.arc(m.x,m.y+6,7,0,Math.PI*2);ctx.fill();
      }
      // draw feet markers
      ctx.fillStyle="yellow";
      feet.forEach(f=>{
        ctx.beginPath();
        ctx.arc(f.x,f.y,15,0,Math.PI*2);
        ctx.fill();
      });
      if(gameRunning) requestAnimationFrame(draw);
    }

    function startGame(){
      score=0;timeSec=0;moles=[];lastFootX=null;feet=[];prevFeet=[];
      scoreEl.textContent=0;timeEl.textContent=0;
      document.getElementById('gameOver').style.display='none';
      gameRunning=true;
      if(spawnTimer) clearInterval(spawnTimer);
      if(secondTimer) clearInterval(secondTimer);
      spawnTimer=setInterval(spawnMole,SPAWN_INTERVAL_MS);
      secondTimer=setInterval(()=>{if(!gameRunning)return;timeSec++;timeEl.textContent=timeSec;if(timeSec>=60)endGame();},1000);
      spawnMole();
      requestAnimationFrame(draw);
    }

    function endGame(){
      gameRunning=false;
      if(spawnTimer) clearInterval(spawnTimer);
      if(secondTimer) clearInterval(secondTimer);

      let statsEl=document.getElementById('finalStats');
      if(score>highScore){
        highScore=score;
        statsEl.innerHTML=`<div class="new-high">üéâ New High Score!</div><div>Score: ${score}</div><div>Time: ${timeSec}s</div>`;
      }else{
        statsEl.innerHTML=`<div>Your Score: ${score}</div><div>High Score: ${highScore}</div><div>Time: ${timeSec}s</div>`;
      }
      document.getElementById('gameOver').style.display='flex';
    }

    window.addEventListener('load',()=>{resizeCanvas();initPose();video.addEventListener('loadedmetadata',resizeCanvas,{once:true});startGame();});
  </script>
  </body>
</html>
