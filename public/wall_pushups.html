<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Wall Push-Ups - Rehabify</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>💪</text></svg>" />
  
  <!-- MediaPipe (camera helper + pose) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose/pose.js"></script>

  <style>
    /* Minimalist CSS with custom color scheme (same as Leg Raises) */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root { --primary:#172141; --secondary:#060e26; --text:#b9d8c0; --accent:#7ee1ff; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,var(--primary) 0%,var(--secondary) 100%);
      color:var(--text); min-height:100vh; line-height:1.6; overflow:hidden;
    }
    h1,h2,h3,h4,h5,h6{font-weight:600;color:var(--text);margin-bottom:0.5rem;}
    /* Utilities */
    .flex{display:flex;} .flex-col{flex-direction:column;} .items-center{align-items:center;}
    .justify-center{justify-content:center;} .justify-between{justify-content:space-between;}
    .gap-4{gap:1rem;} .gap-6{gap:1.5rem;} .p-4{padding:1rem;} .p-6{padding:1.5rem;}
    .px-3{padding-left:0.75rem;padding-right:0.75rem;} .px-8{padding-left:2rem;padding-right:2rem;}
    .py-1{padding-top:0.25rem;padding-bottom:0.25rem;} .py-3{padding-top:0.75rem;padding-bottom:0.75rem;}
    .mt-4{margin-top:1rem;} .mt-8{margin-top:2rem;} .mb-2{margin-bottom:0.5rem;} .mb-6{margin-bottom:1.5rem;}
    .mx-auto{margin-left:auto;margin-right:auto;} .w-full{width:100%;} .h-full{height:100%;}
    .max-w-4xl{max-width:56rem;} .min-h-96{min-height:24rem;} .text-xs{font-size:0.75rem;}
    .text-sm{font-size:0.875rem;} .text-lg{font-size:1.125rem;} .text-3xl{font-size:1.875rem;}
    .text-4xl{font-size:2.25rem;} .font-bold{font-weight:700;} .font-semibold{font-weight:600;}
    .text-center{text-align:center;} .text-right{text-align:right;} .rounded-2xl{border-radius:1rem;}
    .rounded-full{border-radius:9999px;} .relative{position:relative;} .absolute{position:absolute;}
    .inset-0{top:0;right:0;bottom:0;left:0;} .object-cover{object-fit:cover;} .overflow-hidden{overflow:hidden;}
    .grid{display:grid;} .grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr));} .grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr));}
    .space-y-4 > * + *{margin-top:1rem;}
    @media (min-width: 1024px){ .lg\:grid-cols-4{grid-template-columns:repeat(4,minmax(0,1fr));} .lg\:col-span-3{grid-column:span 3 / span 3;} }
    /* Colors */
    .bg-gray-900{background-color:rgba(17,24,39,1);} .bg-gray-800{background-color:rgba(31,41,55,1);}
    .text-gray-300{color:rgba(209,213,219,1);} .text-gray-400{color:rgba(156,163,175,1);}
    .border-gray-700{border-color:rgba(55,65,81,1);} .border-b{border-bottom-width:1px;} .border-t{border-top-width:1px;}
    /* Components */
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:0.5rem;padding:0.75rem 1.5rem;border-radius:0.5rem;font-weight:500;transition:all 0.2s;cursor:pointer;border:none;text-decoration:none;}
    .btn-primary{background-color:#67e8f9;color:var(--primary);} .btn-primary:hover{background-color:#a7f3d0;transform:scale(1.05);}
    .btn-secondary{background-color:rgba(55,65,81,0.5);color:var(--text);border:1px solid rgba(185,216,192,0.2);}
    .btn-secondary:hover{background-color:rgba(75,85,99,0.5);border-color:rgba(185,216,192,0.3);}
    .card{background-color:rgba(55,65,81,0.3);backdrop-filter:blur(10px);border:1px solid rgba(185,216,192,0.1);border-radius:1rem;padding:1.5rem;transition:all 0.2s;}
    .card:hover{background-color:rgba(55,65,81,0.4);}
    /* Video + Canvas */
    #video{width:100%;height:auto;max-width:800px;max-height:600px;display:block;}
    #overlay{pointer-events:none;z-index:10;}
    /* Live Feedback */
    .live-feedback-container{min-height:3rem;padding:0.75rem;border-radius:0.5rem;background-color:rgba(55,65,81,0.2);border:1px solid rgba(185,216,192,0.1);transition:all 0.3s ease;display:flex;align-items:center;justify-content:center;text-align:center;}
    .live-feedback-container.correction{background-color:rgba(239,68,68,0.2);border-color:rgba(239,68,68,0.3);color:#fca5a5;}
    .live-feedback-container.success{background-color:rgba(34,197,94,0.2);border-color:rgba(34,197,94,0.3);color:#86efac;}
    .live-feedback-container.warning{background-color:rgba(245,158,11,0.2);border-color:rgba(245,158,11,0.3);color:#fde047;}
    /* Toast/Coach */
    .toast{background:linear-gradient(135deg,#67e8f9 0%,#7ee1ff 100%);color:var(--primary);padding:15px;border-radius:15px;margin-bottom:15px;font-weight:600;font-size:1.1rem;box-shadow:0 4px 15px rgba(103,232,249,0.3);text-align:center;}
    .level-tag{background-color:rgba(55,65,81,0.8);border:1px solid rgba(185,216,192,0.2);}
    .mascot-card{text-align:center;padding:1rem;}
    .mascot-emoji{font-size:2rem;margin-bottom:0.5rem;transition:transform 0.2s ease;}
    .mascot-label{font-size:0.875rem;color:var(--text);}
    .animate-fade-in{animation:fadeIn 0.5s ease-in;}
    @keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
    @media (max-width:768px){ .grid{grid-template-columns:1fr;} .lg\:col-span-3{grid-column:span 1;} .text-4xl{font-size:1.5rem;} .p-6{padding:1rem;} }
    /* Instruction overlay fade */
    #instructionOverlay{transition:opacity 0.5s ease; z-index: 20;}
    #instructionOverlay.hidden{opacity:0;pointer-events:none;}
    /* End overlay setup (no Tailwind) */
    #endOverlay{
      position: fixed; inset: 0; z-index: 9999;
      background: rgba(0,0,0,0.8); color: #fff;
      display: flex; align-items: center; justify-content: center; text-align: center; padding: 1.5rem;
    }
    #endOverlay.hidden{ display: none; }
    /* Fade-out used when ending */
    .fade-out{ opacity: 0; transition: opacity 0.6s ease; }
  </style>
</head>

<body class="min-h-screen bg-gradient-to-br from-primary to-secondary text-text">
  <div class="animate-fade-in max-w-4xl mx-auto p-4">

    <header class="flex justify-between items-start p-6 border-b border-gray-700 mb-6">
      <div class="flex flex-col">
        <h1 class="text-4xl font-bold mb-2">💪 Wall Push-Ups</h1>
        <div class="text-lg text-gray-300">Go sideways & push toward a wall</div>
      </div>
      <div class="text-right">
        <span class="px-3 py-1 bg-gray-800 rounded-full text-sm level-tag">• Upper Body</span>
        <div class="text-xs text-gray-400 mt-1">Press Start to begin</div>
      </div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-4 gap-6">
      <!-- Video + overlay -->
      <div class="lg:col-span-3 relative">
        <div class="relative bg-gray-900 rounded-2xl overflow-hidden min-h-96">
          <video id="video" playsinline muted class="w-full h-full object-cover"></video>
          <canvas id="overlay" class="absolute inset-0 w-full h-full"></canvas>

          <!-- Instruction overlay (auto hides after 4s) -->
          <div id="instructionOverlay" class="absolute inset-0 flex items-center justify-center bg-black bg-opacity-60 text-white text-center px-8">
            <div>
              <div class="text-3xl font-bold mb-2">Stand sideways to the camera</div>
              <div class="text-lg">Keep your <b>shoulder and hip</b> visible. Lean toward the wall, then return to straight. That’s one rep.</div>
            </div>
          </div>
        </div>
        <!-- Start + Home buttons -->
        <div class="flex justify-center gap-4 mt-4">
          <button id="startBtn" class="btn btn-primary px-8 py-3">▶ Start Exercise</button>
          <button id="homeBtn" class="btn btn-secondary px-8 py-3"> Home</button>
        </div>
      </div>

      <!-- HUD -->
      <aside class="space-y-4">
        <div class="card">
          <div class="text-sm text-gray-400">Reps Remaining</div>
          <div id="repBig" class="text-3xl font-bold">5</div>
        </div>
        
        <div class="card">
          <div class="text-sm text-gray-400">Status</div>
          <div id="status" class="text-sm">Ready. Click Start when you are set.</div>
        </div>
        
        <div class="card">
          <div class="text-sm text-gray-400">Live Feedback</div>
          <div id="liveFeedback" class="live-feedback-container text-sm">Show your shoulder & hip to the camera</div>
        </div>
        
        <div class="card">
          <div class="text-sm text-gray-400">Exercise Progress</div>
          <div id="exerciseInfo" class="text-sm">Wall Push-Ups | 0/5 completed</div>
        </div>

        <div class="card">
          <div class="grid grid-cols-3 gap-4">
            <div class="text-center">
              <div class="text-xs text-gray-400">Stars</div>
              <div class="text-lg font-semibold" id="stars">0</div>
            </div>
            <div class="text-center">
              <div class="text-xs text-gray-400">Streak</div>
              <div class="text-lg font-semibold" id="streak">0</div>
            </div>
            <div class="text-center">
              <div class="text-xs text-gray-400">Score</div>
              <div class="text-lg font-semibold" id="score">0</div>
            </div>
          </div>
        </div>

        <div id="mascot" class="card mascot-card">
          <div class="mascot-emoji">🤖</div>
          <div class="mascot-label">AI Coach</div>
        </div>
        
        <div id="coachBox" class="toast" style="display:none;"></div>
      </aside>
    </main>

    <footer class="p-6 border-t border-gray-700 mt-8 text-center text-gray-400">
      <div class="text-sm">Lean toward the wall (torso bends), then return to straight at a steady pace</div>
    </footer>
  </div>

  <!-- End / Congratulations overlay (starts hidden) -->
  <div id="endOverlay" class="hidden">
    <div>
      <h2 class="text-4xl font-bold mb-4">🎉 Congratulations!</h2>
      <p class="text-lg mb-6">You’ve finished your Wall Push-Ups</p>
      <button id="endHomeBtn" class="btn btn-primary px-6 py-2">🏠 Go Home Now</button>
      <p class="text-sm text-gray-300 mt-4">Redirecting automatically in 3 seconds...</p>
    </div>
  </div>

  <script>
  // ===== WALL PUSH-UPS (NOSE–ELBOW METHOD) =====
  // DOM
  const video = document.getElementById('video');
  const canvas = document.getElementById('overlay');
  const ctx = canvas.getContext('2d');
  const startBtn = document.getElementById('startBtn');
  const homeBtn = document.getElementById('homeBtn');
  const scoreEl = document.getElementById('score');
  const starsEl = document.getElementById('stars');
  const streakEl = document.getElementById('streak');
  const mascot = document.getElementById('mascot');
  const statusEl = document.getElementById('status');
  const exerciseInfoEl = document.getElementById('exerciseInfo');
  const repBigEl = document.getElementById('repBig');
  const coachBoxEl = document.getElementById('coachBox');
  const liveFeedbackEl = document.getElementById('liveFeedback');

  // State
  let running = false;
  let pose = null;
  let latestLm = null;
  let score = 0, streak = 0, starCount = 0;
  let repCount = 0;
  const totalReps = 5;

  // Phase state machine: "back" → "forward" → "back" (counts rep)
  let phase = "back";
  let lastPhaseChange = 0;
  const PHASE_DEBOUNCE_MS = 300;

  // UI helpers
  const status = msg => { if (statusEl) statusEl.textContent = msg || ''; };
  const coach = msg => { if (coachBoxEl) { coachBoxEl.textContent = msg || ''; coachBoxEl.style.display = msg ? 'block':'none'; } };
  const liveFeedback = (msg, type='') => { if (liveFeedbackEl) { liveFeedbackEl.textContent = msg || ''; liveFeedbackEl.className = `live-feedback-container ${type}`; } };
  function bopMascot(){ if(!mascot) return; mascot.style.transition='transform 120ms ease'; mascot.style.transform='scale(1.06)'; setTimeout(()=>mascot.style.transform='scale(1)',120); }

  // Audio
  let audioCtx = null;
  const initAudio = () => { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); };
  function playDing(){
    if (!audioCtx) return;
    const o = audioCtx.createOscillator(), g = audioCtx.createGain();
    o.type='sine'; o.frequency.value=880; o.connect(g); g.connect(audioCtx.destination);
    const t = audioCtx.currentTime;
    g.gain.setValueAtTime(0,t); g.gain.linearRampToValueAtTime(0.6,t+0.01); g.gain.exponentialRampToValueAtTime(0.0001,t+0.25);
    o.start(t); o.stop(t+0.26);
  }

  // Canvas
  function setCanvasSize(){
    const w = video.videoWidth || 640, h = video.videoHeight || 480;
    canvas.width = w; canvas.height = h;
  }
  function drawCameraFrame(){
    if (video.readyState >= 2) {
      ctx.save(); ctx.scale(-1,1);
      ctx.drawImage(video, -canvas.width, 0, canvas.width, canvas.height);
      ctx.restore();
    } else {
      ctx.clearRect(0,0,canvas.width,canvas.height);
    }
  }

  // Pose helpers
  const visOK = p => !!p && (p.visibility === undefined || p.visibility >= 0.25);
  function toPix(p){ return { x:(1-p.x)*canvas.width, y:p.y*canvas.height, c:(p.visibility ?? 1) }; }

  // --- REP DETECTION ---
  function checkWallPushUps(lm) {
    const nose = lm[0];          // Nose
    const rightElbow = lm[14];   // Right elbow
    const leftElbow = lm[13];    // Left elbow

    if (!nose || (!rightElbow && !leftElbow)) {
      liveFeedback("Show your side (nose + elbow)", "warning");
      return;
    }

    // Pick whichever elbow is more visible
    let elbow = rightElbow;
    if (leftElbow?.visibility > (rightElbow?.visibility || 0)) elbow = leftElbow;

    // Convert to pixel coordinates (mirrored)
    const noseX = (1 - nose.x) * canvas.width;
    const elbowX = (1 - elbow.x) * canvas.width;

    const now = performance.now();
    const canChange = (now - lastPhaseChange) > PHASE_DEBOUNCE_MS;

    // Phase detection
    if (phase === "back" && noseX < elbowX && canChange) {
      phase = "forward"; lastPhaseChange = now;
      liveFeedback("⬇ Nose in front of elbow - pushing in!", "success");
    }
    else if (phase === "forward" && noseX > elbowX && canChange) {
      phase = "back"; lastPhaseChange = now;
      completedRep();
    }

    // Debug markers
    ctx.save();
    const nosePix = toPix(nose);
    const elbowPix = toPix(elbow);
    ctx.fillStyle = "#67e8f9"; ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 10;
    ctx.beginPath(); ctx.arc(nosePix.x, nosePix.y, 8, 0, Math.PI * 2); ctx.fill();
    ctx.beginPath(); ctx.arc(elbowPix.x, elbowPix.y, 8, 0, Math.PI * 2); ctx.fill();
    ctx.strokeStyle = "#7ee1ff"; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(nosePix.x, nosePix.y); ctx.lineTo(elbowPix.x, elbowPix.y); ctx.stroke();
    ctx.shadowBlur = 0;
    ctx.restore();
  }

  function completedRep() {
    repCount++; score += 10; streak++; starCount++;
    playDing(); bopMascot();
    coach(`Nice rep! ${Math.max(0, totalReps - repCount)} to go.`);
    updateUI();

    if (repCount >= totalReps) {
      setTimeout(() => {
        status("Exercise Complete! Great job!");
        coach("🎉 You’ve finished Wall Push-Ups!");
        liveFeedback("Exercise completed successfully!", "success");

        // Fade out HUD + video area
        const mainEl = document.querySelector('main');
        const footerEl = document.querySelector('footer');
        if (mainEl) mainEl.classList.add('fade-out');
        if (footerEl) footerEl.classList.add('fade-out');

        // Show end overlay
        const endOverlay = document.getElementById("endOverlay");
        if (endOverlay) {
          endOverlay.classList.remove("hidden");
          // Bind the button AFTER it exists
          const endHomeBtn = document.getElementById('endHomeBtn');
          if (endHomeBtn && !endHomeBtn.dataset.bound) {
            endHomeBtn.addEventListener('click', () => { window.location.href = "/app"; });
            endHomeBtn.dataset.bound = "1";
          }
        }

        // Auto redirect after 3s
        setTimeout(() => { window.location.href = "/app"; }, 3000);
      }, 400);
    }
  }

  function updateUI(){
    const remaining = Math.max(0, totalReps - repCount);
    repBigEl.textContent = String(remaining);
    scoreEl.textContent = score;
    streakEl.textContent = streak;
    starsEl.textContent = starCount;
    exerciseInfoEl.textContent = `Wall Push-Ups | ${repCount}/${totalReps} completed`;
  }

  // Main loop
  function renderLoop(){
    drawCameraFrame();
    if (latestLm && running) checkWallPushUps(latestLm);
    requestAnimationFrame(renderLoop);
  }

  // Camera
  async function openCameraWithFallbacks(){
    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) throw new Error('getUserMedia not supported');
    const tries = [
      { video: { facingMode: { ideal:'user' }, width:{ ideal:1280 }, height:{ ideal:720 } }, audio:false },
      { video: { facingMode:'user' }, audio:false },
      { video:true, audio:false },
    ];
    let lastErr;
    for (const c of tries){
      try { return await navigator.mediaDevices.getUserMedia(c); }
      catch(e){ lastErr = e; }
    }
    throw lastErr || new Error('Unable to open camera');
  }

  // Start
  async function start(){
    if (running) return;
    running = true;
    try{
      initAudio();
      status('Requesting camera...');
      video.setAttribute('playsinline',''); video.setAttribute('autoplay',''); video.muted = true;
      const stream = await openCameraWithFallbacks();
      video.srcObject = stream;

      await new Promise(res => {
        if (video.readyState >= 1) return res();
        video.addEventListener('loadedmetadata', res, { once:true });
      });

      await video.play();
      setCanvasSize(); window.addEventListener('resize', setCanvasSize);
      renderLoop();
      status('Camera ready - Face a wall & stand sideways');
      coach('Keep your nose and elbow visible. Push toward the wall.');

      // Pose
      if (!window.Pose){ status('ERROR: MediaPipe Pose not loaded'); return; }
      const PoseCtor = window.Pose.Pose || window.Pose;
      pose = new PoseCtor({ locateFile: f => `https://cdn.jsdelivr.net/npm/@mediapipe/pose/${f}` });
      pose.setOptions({ modelComplexity: 1, smoothLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
      pose.onResults(({ poseLandmarks }) => { latestLm = poseLandmarks || null; });

      if (typeof Camera === 'function') {
        const cam = new Camera(video, { onFrame: async () => { await pose.send({ image: video }); }, width: canvas.width, height: canvas.height });
        cam.start();
      } else {
        (async function loop(){ await pose.send({ image: video }); requestAnimationFrame(loop); })();
      }

      status('Exercise started!');
    } catch (e){
      console.error('Camera initialization failed:', e);
      let errorMsg = 'Camera Error: ';
      if (e.name === 'NotAllowedError') errorMsg += 'Camera permission denied. Please allow camera access.';
      else if (e.name === 'NotFoundError') errorMsg += 'No camera found. Please connect a camera.';
      else errorMsg += e?.message || e;
      status(errorMsg);
      running = false;
    }
  }

  // Event listeners
  if (startBtn) startBtn.addEventListener('click', start);
  if (homeBtn) homeBtn.addEventListener('click', () => { window.location.href = "/"; });

  // Instruction overlay auto-hide after 4s (fade away, not display:none)
  setTimeout(() => {
    const ov = document.getElementById('instructionOverlay');
    if (ov) ov.classList.add('hidden');
  }, 4000);

  // Init
  updateUI();
  status('Ready. Click Start when you are set.');
  </script>
</body>
</html>
